ARG PYTHON_VERSION=3.11
FROM sregistry.mts.ru/bigdata/platform/docker-images/python:${PYTHON_VERSION}-slim as test
ARG PYTHON_VERSION

RUN microdnf -y install \
        krb5-libs \
        krb5-workstation \
        krb5-devel \
        cyrus-sasl \
        cyrus-sasl-devel \
        cyrus-sasl-gssapi \
        cyrus-sasl-ldap \
        cyrus-sasl-plain \
        openldap-devel \
        openssl-devel \
        autoconf \
        gcc \
        gcc-c++ \
        make \
        git \
        libnghttp2-1.33.0-3.el8_2.1

WORKDIR /app
ENV PYTHONPATH=/app

RUN set +x\
    && pip install poetry \
    && poetry config virtualenvs.create false \
    # https://github.com/python-poetry/poetry/issues/6705
    && export POETRY_CONFIG=$(python -c 'from poetry.locations import CONFIG_DIR; print(CONFIG_DIR)') \
    && cd $POETRY_CONFIG \
    && poetry init --name poetry-instance \
    && poetry source add --priority=default nexus https://nexus.services.mts.ru/repository/pip/simple \
    && if [[ "x${PYTHON_VERSION}" != "x3.7" ]]; then \
        poetry self add poetry-bumpversion; \
       fi

COPY ./pyproject.toml ./poetry.lock* ./

# TODO: remove sphinx-plantuml install after solving https://github.com/zqmillet/sphinx-plantuml/pull/4
RUN pip install sphinx-plantuml && \
    poetry install \
        --no-root \
        --all-extras \
        --with dev,test,docs

ARG PYDANTIC_VERSION=2
RUN if [[ "x${PYDANTIC_VERSION}" == "x1" ]]; then \
        # pydantic-settings depends in pydantic>2.3, so delete it
        # urllib3 v1 lack some options from v2, test it too
        pip uninstall -y "pydantic-settings"; \
        pip install "pydantic<2" "autodoc-pydantic<2" "urilib3<2.0"; \
    fi
